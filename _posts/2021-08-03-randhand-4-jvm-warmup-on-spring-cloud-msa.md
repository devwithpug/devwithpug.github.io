---
title: 'JVM Warm Upìœ¼ë¡œ ìŠ¤í”„ë§ í´ë¼ìš°ë“œì˜ ì²« ë²ˆì§¸ ìš”ì²­ ë”œë ˆì´ ì—†ì• ê¸°'
categories: project
tags: ['project', 'randhand-chat']
header:
    teaser: /assets/teasers/randhand.jpg
---

__[<font size="50">ğŸ‘‹ëœì†ì±— í”„ë¡œì íŠ¸ ê¹ƒí—ˆë¸Œ ë°”ë¡œê°€ê¸°</font>](https://github.com/devwithpug/RandHand-Chat){:target="_blank"}{:size="50pt"}__

- - -

# ê°œìš”

ìŠ¤í”„ë§ í´ë¼ìš°ë“œë¥¼ í†µí•´ MSAë¥¼ ì„¤ê³„í•˜ë©´ì„œ í•œ ê°€ì§€ ë¬¸ì œê°€ ìˆì—ˆëŠ”ë° ì„œë²„ê°€ ì‹¤í–‰ëœ í›„, í˜¹ì€ ì„œë²„ì˜ ìš”ì²­ì´ ì—†ëŠ” IDLE ìƒíƒœë¡œ 1~2ì‹œê°„ì´ ê²½ê³¼í•œ ê²½ìš°ì— __ì²« ë²ˆì§¸ ìš”ì²­ ë˜ëŠ” ìƒˆë¡œìš´ ìš”ì²­ì´ ë°œìƒí•˜ë©´ Response Timeì´ ë§¤ìš° ëŠë¦° ê²ƒ__ ì´ì—ˆë‹¤. ë¨¼ì € í´ë¼ìš°ë“œ ì¸ìŠ¤í„´ìŠ¤ì™€ MSA ì„œë²„ êµ¬ì„±ì€ ì•„ë˜ì™€ ê°™ë‹¤.

* í´ë¼ìš°ë“œ ì¸ìŠ¤í„´ìŠ¤

> ğŸŒ __ì›ê²© ì„œë²„__   
> í´ë¼ìš°ë“œ ì„œë²„ : AWS EC2 - í”„ë¦¬ í‹°ì–´(t2.micro)   
> ìš´ì˜ ì²´ì œ : Amazon Linux 2   
> CPU : 1 vCPU   
> RAM : 1 GiB   
> HDD : 30 GB   

* MSA êµ¬ì„± ìš”ì•½

[![image](https://user-images.githubusercontent.com/69145799/127898508-4e9aefeb-05ac-49d9-b632-1ba48334d403.png){:.align-center}](https://user-images.githubusercontent.com/69145799/127898508-4e9aefeb-05ac-49d9-b632-1ba48334d403.png)

ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì–´ë–¤ ì‹œë„ë¥¼ í–ˆëŠ”ì§€, ê·¸ë¦¬ê³  ì–´ë–¤ ê²°ê³¼ë¥¼ ì–»ì—ˆëŠ”ì§€ ì •ë¦¬í•´ë³´ì•˜ë‹¤.

# ë¬¸ì œì 

EC2 ì¸ìŠ¤í„´ìŠ¤ ìœ„ì— ë°±ì—”ë“œ ì„œë²„ë¥¼ ì˜¬ë¦° í›„ [Postman](https://www.postman.com/){:target="_blank"}ì„ í†µí•´ ê°„ë‹¨í•œ ë¡œê·¸ì¸ ìš”ì²­ì„ ì „ì†¡í–ˆì„ ë•Œì˜ ì‘ë‹µ ê²°ê³¼ì´ë‹¤.

![image](https://user-images.githubusercontent.com/69145799/127872712-79e28fe1-1df7-425e-8337-a6c6d96acaf6.png){:.align-center}

> â¬†ï¸ ì²«ë²ˆì§¸ ìš”ì²­ì˜ ì‘ë‹µê¹Œì§€ ë¬´ë ¤ 38.75 ì´ˆê°€ ê²°ë ¸ë‹¤.. í•˜í•˜í•˜

t2.micro ì¸ìŠ¤í„´ìŠ¤ì˜ ì»´í“¨íŒ… íŒŒì›Œê°€ ì¢‹ì§€ ì•Šì•„ì„œ ìœ„ì™€ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì™”ì§€ë§Œ ì—¬ëŸ¬ ë²ˆ í…ŒìŠ¤íŠ¸í•´ë³¸ ê²°ê³¼ í‰ê· ì ìœ¼ë¡œ `20s` ì •ë„ì˜ ì‘ë‹µ ì‹œê°„ì´ ì†Œìš”ë˜ì—ˆë‹¤. ë”°ë¼ì„œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë¡œì»¬ í™˜ê²½ì—ì„œ ì—¬ëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì•˜ë‹¤.

# í…ŒìŠ¤íŠ¸

ê°ê°ì˜ í…ŒìŠ¤íŠ¸ëŠ” ë¡œì»¬ í™˜ê²½(Mac mini M1 16GB RAM)ì—ì„œ ì§„í–‰í–ˆìœ¼ë©° ë°±ê·¸ë¼ìš´ë“œ í™˜ê²½ì„ ì„œë²„ì™€ ë™ì¼í•˜ê²Œ êµ¬ì„±í•˜ì˜€ë‹¤.

1. `chat-service` ë§Œ ë¶„ë¦¬í•˜ì—¬ ì²« ë²ˆì§¸ ìš”ì²­ í…ŒìŠ¤íŠ¸
2. MSA í™˜ê²½ì—ì„œ ìœ ë ˆì¹´ ì„œë²„ë¥¼ ì œì™¸í•œ ëª¨ë“  ì„œë¹„ìŠ¤(gateway, chat, ...)ê°€ ì¬ê¸°ë™ ëœ ê²½ìš° ì²« ë²ˆì§¸ ìš”ì²­ í…ŒìŠ¤íŠ¸
3. MSA í™˜ê²½ì—ì„œ `chat-service`ë§Œ ì¬ê¸°ë™ ëœ ê²½ìš° ì²« ë²ˆì§¸ ìš”ì²­ í…ŒìŠ¤íŠ¸

ìœ ë ˆì¹´ ì„œë²„ì˜ ê²½ìš° Response Timeì— í° ì˜í–¥ì„ ì£¼ì§€ ì•Šì•„ì„œ ì œì™¸í•˜ì˜€ë‹¤. ë˜í•œ __ì²« ë²ˆì§¸ ìš”ì²­ ì´í›„ì—ëŠ” ëª¨ë“  í…ŒìŠ¤íŠ¸ì—ì„œ í‰ê·  `80ms` ì˜ ì‘ë‹µì†ë„ë¥¼ ë³´ì˜€ë‹¤.__

* `ì²«ë²ˆì§¸ ìš”ì²­ì˜ ì‘ë‹µ ì‹œê°„` -> `ë‹¤ìŒ ìš”ì²­ì˜ ì‘ë‹µ ì‹œê°„`

|         | chat-service ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ | MSA (gateway, chat-serviceë§Œ ì¬ê¸°ë™) | MSA (chat-serviceë§Œ ì¬ê¸°ë™) |
| :------ | :----------------------- | :----------------------------------- | :-------------------------- |
| 1       | 503ms -> 79ms            | 1231ms -> 111ms                      | 519ms -> 93ms               |
| 2       | 508ms -> 71ms            | 1093ms -> 89ms                       | 614ms -> 101ms              |
| 3       | 523ms -> 93ms            | 1024ms -> 101ms                      | 565ms -> 85ms               |
| 4       | 497ms -> 87ms            | 1115ms -> 93ms                       | 526ms -> 90ms               |
| 5       | 564ms -> 81ms            | 1062ms -> 98ms                       | 534ms -> 88ms               |
| __avg__ | __519ms(6.49x)__         | __1105ms(13.8x)__                    | __551.6ms(6.895x)__         |

ì´ì²˜ëŸ¼ ì •ìƒì ì¸ Response Timeì— ë¹„í•´ 6, 13ë°°ê°€ëŸ‰ì˜ ì‹œê°„ì´ ì†Œìš”ë˜ì—ˆê³  `gateway-service` ì™€ `chat-service` ê°ê°ì˜ í™˜ê²½ì—ì„œ ë”œë ˆì´ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

# ì›ì¸ & í•´ê²°

## ì›ì¸

ê°€ì¥ ë¨¼ì € __'ì²« ë²ˆì§¸ ìš”ì²­ì—ì„œë§Œ ì¶”ê°€ì ì¸ ë”œë ˆì´ê°€ ë°œìƒí•œë‹¤'__ ëŠ” ì¡°ê±´ì— í¬ì»¤ìŠ¤ë¥¼ ë§ì¶”ì—ˆë‹¤. ì—¬ëŸ¬ ìë£Œë“¤ì„ ì°¾ì•„ë³´ë©´ì„œ ë¬¸ì œì˜ ì›ì¸ì— ëŒ€í•´ í™•ì‹ ì„ ê°€ì§ˆ ìˆ˜ ìˆì—ˆë‹¤.

ì›ì¸ì„ ì•Œê¸° ì „ì— JVM ì•„í‚¤í…ì²˜ì— ëŒ€í•´ ë¨¼ì € ì„¤ëª…í•  í•„ìš”ê°€ ìˆë‹¤. ìƒˆë¡œìš´ JVM í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ë  ë•Œë§ˆë‹¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì— í•„ìš”í•œ ëª¨ë“  í´ë˜ìŠ¤ëŠ” `ClassLoader`ì˜ ì¸ìŠ¤í„´ìŠ¤ì— ì˜í•´ ë©”ëª¨ë¦¬ì— ë¡œë“œëœë‹¤. ì´ëŸ¬í•œ Load í”„ë¡œì„¸ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì´ 3ë‹¨ê³„ë¡œ ì§„í–‰ëœë‹¤.

1. __Bootstrap Class Loading__ : Java ì½”ë“œì™€ `java.lang.Object` ì™€ ê°™ì€ í•„ìˆ˜ í´ë˜ìŠ¤ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œí•¨
2. __Extension Class Loading__ : `java.ext.dirs` ê²½ë¡œì— ìˆëŠ” ëª¨ë“  JAR íŒŒì¼ì„ ë¡œë“œí•¨(ê°œë°œìê°€ ìˆ˜ë™ìœ¼ë¡œ JARì„ ì¶”ê°€í•˜ëŠ” ê²½ìš°)
3. __Application Class Loading__ : ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤ ê²½ë¡œì— ìˆëŠ” ëª¨ë“  í´ë˜ìŠ¤ë¥¼ ë¡œë“œí•¨

ì´ë•Œ ì¤‘ìš”í•œ ê²ƒì€ __ì´ëŸ¬í•œ ì´ˆê¸°í™” í”„ë¡œì„¸ìŠ¤ê°€ ì§€ì—° ë¡œë”©(LAZY LOADING) ë°©ì‹ì„ ê¸°ë°˜ìœ¼ë¡œ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.__

í´ë˜ìŠ¤ ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ê³¼ ë™ì‹œì— í•„ìš”í•œ ì¤‘ìš”í•œ í´ë˜ìŠ¤ê°€ JVM ìºì‹œë¡œ í‘¸ì‹œ ë˜ì–´ ëŸ°íƒ€ì„ ì¤‘ì— ë¹ ë¥´ê²Œ ì•¡ì„¸ìŠ¤ê°€ ê°€ëŠ¥í•œ ê²ƒì´ê³ . ì´ë¥¼ ì œì™¸í•œ ë‹¤ë¥¸ í´ë˜ìŠ¤ë“¤ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¼ ë•Œ ì‹¤ì œ ìš”ì²­ì´ ë°œìƒë˜ì–´ì•¼ë§Œ ë¡œë“œëœë‹¤.(per-request basis)

ë”°ë¼ì„œ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì™€ ê°™ì´ Java ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì²« ë²ˆì§¸ ìš”ì²­ì˜ ì‘ë‹µì´ í‰ê·  ì‘ë‹µ ì‹œê°„ë³´ë‹¤ í›¨ì”¬ ëŠë¦° ì´ìœ ëŠ” ìœ„ì™€ ê°™ì´ JVM ì•„í‚¤í…ì²˜ê°€ ì§€ì—° í´ë˜ìŠ¤ ë¡œë”©ê³¼ JIT ì»´íŒŒì¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

> ì‘ë‹µ ì‹œê°„ì´ í¬ë¦¬í‹°ì»¬í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì„¤ê³„í•  ë•ŒëŠ” ì´ëŸ¬í•œ JVM ì•„í‚¤í…ì²˜ êµ¬ì¡°ë¥¼ ì—¼ë‘ì— ë‘ì–´ ì‘ë‹µì— í•„ìš”í•œ í´ë˜ìŠ¤ë“¤ì´ ë¬´ì—‡ì¸ì§€ ì •í™•íˆ ì•Œì•„ì•¼ í•˜ë©° ì´ëŸ¬í•œ í´ë˜ìŠ¤ë“¤ì„ ë¯¸ë¦¬ ìºì‹œ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤!

## í•´ê²°

### ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œì˜ Warm Up ë°©ë²•

ìœ„ì™€ ê°™ì´ ì§€ì—° ë¡œë”©ì„ í•˜ëŠ” í´ë˜ìŠ¤ë“¤ì„ ë¯¸ë¦¬ Warm Up í•˜ë ¤ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì´ˆê¸°í™”ëœ í›„ì— Warm Up ì„ ìˆ˜í–‰í•˜ì—¬ì•¼ í•œë‹¤. ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œëŠ” ê°„ë‹¨íˆ `ApplicationListener` ì˜ êµ¬í˜„ì²´ë¥¼ í†µí•´ Warm Up í”„ë¡œì„¸ìŠ¤ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

```java
@Component
public class ApplicationStartup implements ApplicationListener<ApplicationReadyEvent> {

    // ApplicationReadyEventê°€ í˜¸ì¶œë  ë•Œ ì‹¤í–‰ë˜ëŠ” ë©”ì†Œë“œ
    @Override
    public void onApplicationEvent() {
        
        // í´ë˜ìŠ¤ Warm Up ìˆ˜í–‰

    }
}
```

### Warm Up í…ŒìŠ¤íŠ¸

JVM Warm Up ì„ ì´ìš©í•˜ì—¬ ë¬¸ì œê°€ í•´ê²°ë  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ `chat-service` ë§Œ ë¶„ë¦¬í•˜ì—¬ ê°„ë‹¨íˆ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ì•˜ë‹¤.

ê°€ì¥ ë¨¼ì € ë¡œê·¸ì¸ì„ ë‹´ë‹¹í•˜ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ `UserDetailsService` ë©”ì†Œë“œì¸ `loadUserByUsername`ì„ í˜¸ì¶œí•˜ì—¬ ê´€ë ¨ëœ í´ë˜ìŠ¤ë“¤ì„ ë¯¸ë¦¬ ë©”ëª¨ë¦¬ì— ìºì‹±í•˜ë„ë¡ í•˜ì˜€ë‹¤.

* `ì²«ë²ˆì§¸ ìš”ì²­ì˜ ì‘ë‹µ ì‹œê°„` -> `ë‹¤ìŒ ìš”ì²­ì˜ ì‘ë‹µ ì‹œê°„`

|         | loadByUsername Warm Up (X) | loadByUsername Warm Up (O) |
| :------ | :------------------------- | :------------------------- |
| 1       | 518ms -> 84ms              | 419ms -> 84ms              |
| 2       | 614ms -> 91ms              | 404ms -> 77ms              |
| 3       | 542ms -> 89ms              | 451ms -> 93ms              |
| 4       | 534ms -> 93ms              | 442ms -> 98ms              |
| 5       | 497ms -> 78ms              | 427ms -> 83ms              |
| __avg__ | __541ms(6.76x)__           | __428.6ms(5.35x)__         |

ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ `User` ê°ì²´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” `loadByUsername` ë©”ì†Œë“œë¥¼ Warm Up í–ˆì„ ë¿ì¸ë° ìœ ì˜ë¯¸í•œ ê²°ê³¼ê°€ ë‚˜ì™”ë‹¤. ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ì˜ ëª¨ë“  í´ë˜ìŠ¤ë“¤ì„ Warm Up í•˜ì§€ ì•Šì•˜ìŒì—ë„ `100ms` ê°€ëŸ‰ì˜ ì‘ë‹µ ì†ë„ë¥¼ ê°œì„ í•  ìˆ˜ ìˆì—ˆë‹¤!

### íš¨ê³¼ì ìœ¼ë¡œ Warm Up í•˜ê¸°

ë‚˜ëŠ” ì„œë²„ì˜ ì²« ë²ˆì§¸ ì‘ë‹µ ì†ë„ê°€ í‰ê·  ì†ë„ì™€ ë‹¤ë¥¼ ë°” ì—†ëŠ” `80~100ms` ì •ë„ì˜ ì‹œê°„ì„ ê²°ê³¼ë¡œ ì–»ê³  ì‹¶ì—ˆë‹¤. ê·¸ëŸ¬ê¸° ìœ„í•´ì„  ì‹¤ì œ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒëª…ì£¼ê¸°ì—ì„œ ì§€ì—° ë¡œë”©ë˜ëŠ” í´ë˜ìŠ¤ë“¤ì„ ëª¨ë‘ Warm Up í•  í•„ìš”ê°€ ìˆì—ˆë‹¤.

í•˜ì§€ë§Œ Warm Up í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ë“¤ì„ í•˜ë‚˜í•˜ë‚˜ ì°¾ì•„ì„œ ì„ì˜ë¡œ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ìƒê°ë³´ë‹¤ ì‰½ì§€ ì•Šì•˜ê³  ì˜¤íˆë ¤ ë¹„íš¨ìœ¨ì ì´ë¼ê³  ìƒê°í–ˆë‹¤. ìŠ¤í”„ë§ ì•„í‚¤í…ì²˜ë¥¼ ì™„ì „íˆ íŒŒì•…í•˜ê³  ìˆì–´ì•¼ í•¨ì€ ë¬¼ë¡ ì´ê³ , ëª¨ë“  ìŠ¤í”„ë§ ë¹ˆ í´ë˜ìŠ¤ë“¤ì˜ ìƒëª…ì£¼ê¸°ì™€ ì–´ë–¤ ì„¤ê³„, ì–´ë–¤ ë™ì‘ì„ í•˜ëŠ”ì§€ ëª¨ë‘ ì•Œì•„ì•¼ í–ˆê¸° ë•Œë¬¸ì´ë‹¤.

ë”°ë¼ì„œ ë‚´ë¶€ë¡œ íŒŒê³  ë“¤ì–´ê°€ëŠ” ë°©ë²•ë³´ë‹¤ ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ íƒí–ˆë‹¤. `RestTemplate` í´ë˜ìŠ¤ë¥¼ í†µí•˜ì—¬ ì§ì ‘ ì• í”Œë¦¬ì¼€ì´ì…˜ì— Http ìš”ì²­ì„ ë³´ë‚´ëŠ” ë°©ë²•ì´ë‹¤.

ì´ëŠ” JVM Warm Up ê³¼ëŠ” ê±°ë¦¬ê°€ ë©€ë‹¤ê³  ìƒê°í•  ìˆ˜ë„ ìˆì§€ë§Œ, Warm Upì€ ì§€ì—° ë¡œë”© í´ë˜ìŠ¤ë¥¼ ë¯¸ë¦¬ ìºì‹œì— ì˜¬ë¦¬ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. ë˜í•œ `RestTemplate` ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì‹¤ì œ ì„œë²„ì— ìš”ì²­í•˜ëŠ” ìƒí™©ì„ ê°€ì •í•˜ì—¬ ë¯¸ë¦¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ë‹¨ê³„ì—ì„œ í•´ë‹¹ ìš”ì²­ì„ ë°œìƒì‹œì¼œ í•„ìš”í•œ í´ë˜ìŠ¤ë“¤ì„ ë©”ëª¨ë¦¬ì— ìºì‹± í•˜ëŠ” ê²ƒì´ë¯€ë¡œ ìŠ¤í”„ë§ê³¼ ê°™ì€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ Warm Upì— íš¨ê³¼ì ì´ë¼ê³  íŒë‹¨í–ˆë‹¤.

### RestTemplate Warm Up í…ŒìŠ¤íŠ¸

```java
@Override
public void onApplicationEvent() {
    
    RequestUser req = RequestUser.builder().email("t@t").auth("t").picture("t").name("t").build();
    HttpHeaders headers = new HttpHeaders();
    headers.add("Content-Type", "application/json");
    headers.add("Accept", "application/json");
    headers.add("Accept-Encoding", "gzip, deflate, br");

    HttpEntity<RequestUser> requestUserHttpEntity = new HttpEntity<>(req, headers);

    RestTemplate rt = new RestTemplate();

    try {

        // localhostì— RestTemplate call ìˆ˜í–‰
        // 1. ìœ ì € íšŒì›ê°€ì… ìš”ì²­
        // 2. ìœ ì € ì¡°íšŒ ìš”ì²­
        // 3. ìœ ì € íšŒì›íƒˆí‡´ ìš”ì²­

    } catch (Exception e) {
        log.warn(e.toString());
    }
}
```

ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê²ƒê³¼ ë™ì¼í•˜ê²Œ êµ¬ì„±í•˜ì—¬ HTTP ìš”ì²­ì„ ë³´ë‚´ë„ë¡ ì½”ë“œë¥¼ ì‘ì„±í•˜ì—¬ í…ŒìŠ¤íŠ¸í–ˆë‹¤.

* `ì²«ë²ˆì§¸ ìš”ì²­ì˜ ì‘ë‹µ ì‹œê°„` -> `ë‹¤ìŒ ìš”ì²­ì˜ ì‘ë‹µ ì‹œê°„`

|         | RestTemplate Warm Up (X) | RestTemplate Warm Up (O) |
| :------ | :----------------------- | :----------------------- |
| 1       | 518ms -> 84ms            | 103ms -> 111ms           |
| 2       | 614ms -> 91ms            | 97ms -> 86ms             |
| 3       | 542ms -> 89ms            | 89ms -> 83ms             |
| 4       | 534ms -> 93ms            | 95ms -> 101ms            |
| 5       | 497ms -> 78ms            | 81ms -> 93ms             |
| __avg__ | __541ms(6.76x)__         | __93ms(1.16x)__          |

ê¸°ëŒ€í–ˆë˜ ê²°ê³¼ê°€ ë‚˜ì™”ë‹¤! ì²«ë²ˆì§¸ ìš”ì²­ê³¼ ê·¸ ì´í›„ ìš”ì²­ë“¤ì˜ ì‘ë‹µì‹œê°„ì„ ë™ì¼í•˜ê²Œ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤!!!

### `gateway-service` Warm Up ìˆ˜í–‰

`chat-service` ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì—ì„œ ì›í•˜ë˜ ê²°ê³¼ë¥¼ ì–»ì—ˆê¸° ë•Œë¬¸ì— `gateway-service` ì—ì„œë„ ì´ì™€ ê°™ì´ Warm Upì„ ìˆ˜í–‰í•˜ì˜€ë‹¤.

í•˜ì§€ë§Œ `gateway-service` ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ë¶€ì—ì„œ Warm Upì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒë³´ë‹¤ `chat-service`ì—ì„œ `gateway-service`ë¡œ HTTP ìš”ì²­ì„ ë³´ë‚´ë„ë¡ í•˜ëŠ” ê²ƒì´ ì˜³ë‹¤ê³  ìƒê°í–ˆìœ¼ë©° ê·¸ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

1. ì„œë²„ì— ë°°í¬í•  ë•Œ `chat-service` ë³´ë‹¤ ë¨¼ì € `gateway-service` ê°€ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— `gateway-service` ì—ì„œ Warm Upì„ ìˆ˜í–‰í•˜ë©´ ì‹¤ì œ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ `chat-service`ë¡œ ìš”ì²­ì´ ê°€ë„ë¡ í•˜ëŠ” `spring-cloud-gateway` í´ë˜ìŠ¤ë“¤ì˜ Warm Upì„ ì™„ë²½í•˜ê²Œ ìˆ˜í–‰í•  ìˆ˜ ì—†ë‹¤.

2. `gateway-service` ëŠ” ë¡œë“œ ë°¸ëŸ°ì‹±ì˜ ì—­í• ë§Œ í•˜ê¸° ë•Œë¬¸ì— ë…ìì ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ & ë¡œì§ ë³´ë‹¤ `eureka-server`, `ë‹¤ë¥¸ MSA ì„œë¹„ìŠ¤` ë“¤ì— ì˜ì¡´í•˜ëŠ” ë¡œì§ì´ ë§ë‹¤.

ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ HTTP ìš”ì²­ì„ ë³´ë‚´ë„ë¡ í•˜ì˜€ë‹¤.

```java
/* onApplicationEvent ë‚´ë¶€ */

RestTemplate rt = new RestTemplate();

ResponseEntity<String> response = rt.getForEntity(
        // Docker ë„¤íŠ¸ì›Œí¬ì˜ ë‚´ë¶€ ì»¨í…Œì´ë„ˆë¡œ ì ‘ê·¼
        "http://gateway-service:8000/chat-service/" + URI,
        String.class
        );
```

### Spring Scheduler ë“±ë¡

ì„œë²„ ì‹¤í–‰ í›„ ì²« ë²ˆì§¸ ìš”ì²­ì— ëŒ€í•´ì„œëŠ” ì›í•˜ëŠ” ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤. í•˜ì§€ë§Œ 1ì‹œê°„ ì •ë„ì˜ IDLE ìƒíƒœ ì´í›„ì— ìƒˆë¡œìš´ ìš”ì²­ì„ ì „ì†¡í•  ë•Œ ì´ì „ê³¼ ê°™ì´ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì¸í•œ ì‘ë‹µ ì‹œê°„ì— ë”œë ˆì´ê°€ ìƒê¸°ëŠ” í˜„ìƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

ë”°ë¼ì„œ 24ì‹œê°„ ì‹¤í–‰ë˜ëŠ” ì„œë²„ì— ëŒ€í•´ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ë“±ë¡í•˜ì—¬ ì„¤ì •ëœ ì‹œê°„ë§ˆë‹¤ Warm Upì„ ìˆ˜í–‰í•˜ë„ë¡ í•˜ì˜€ë‹¤.

* `ChatServiceApplication.java`

```java
@SpringBootApplication
@EnableDiscoveryClient
@EnableScheduling // ìŠ¤ì¼€ì¤„ëŸ¬ í™œì„±í™”
public class ChatServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ChatServiceApplication.class, args);
    }

}
```

* `WarmUpService.java`

```java
@Component
public class WarmUpService {

    // ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡
    @Scheduled(fixedDelay = 30 * 60 * 1000)
    public void onApplicationEvent() {

        // Warm Up code

    }
}
```

## ê²°ê³¼

ì„œë²„ ì²« ì‹¤í–‰ ë˜ëŠ” IDLE ìƒíƒœ ì´í›„ì— ë°œìƒë˜ëŠ” ìš”ì²­ì˜ ë”œë ˆì´ë¥¼ ì™„ë²½íˆ ì—†ì•¨ ìˆ˜ ìˆì—ˆë‹¤!

HTTP ìš”ì²­ì„ í†µí•´ Warm Up í•˜ëŠ” ê²ƒì´ ìµœì„ ì˜ ì„ íƒì€ ì•„ë‹ ìˆ˜ ìˆì§€ë§Œ ì›í•˜ëŠ” ê²°ê³¼ë¥¼ ì–»ì—ˆê³  ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ìš©í•˜ê¸°ì—ëŠ” ì¢‹ì€ ë°©ë²•ì¸ ê²ƒ ê°™ë‹¤.

> êµ¬í˜„ëœ ì½”ë“œëŠ” [WarmUpService.java](https://github.com/devwithpug/RandHand-Chat/blob/main/backend/chat-service/src/main/java/io/kgu/chatservice/config/WarmUpService.java){:target="_blank"} ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# References

* [https://stackoverflow.com/questions/59242577/why-my-springboot-with-embbeded-tomcat-too-slow-when-process-first-request](https://stackoverflow.com/questions/59242577/why-my-springboot-with-embbeded-tomcat-too-slow-when-process-first-request){:target="_blank"}

* [https://stackoverflow.com/questions/57312745/slow-first-call-after-restarting-spring-boot-application](https://stackoverflow.com/questions/57312745/slow-first-call-after-restarting-spring-boot-application){:target="_blank"}

* [https://www.baeldung.com/java-jvm-warmup](https://www.baeldung.com/java-jvm-warmup){:target="_blank"}