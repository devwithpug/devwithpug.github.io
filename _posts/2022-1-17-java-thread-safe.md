---
title: 'ìë°”ì—ì„œ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” 3ê°€ì§€ í‚¤ì›Œë“œ'
categories: java
tags: ['java', 'synchronization']
header:
    teaser: /assets/teasers/java.jpg
---

# ê°œìš”

ìë°”ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•˜ë‹¤ ë³´ë©´ ë™ì‹œì„± ë¬¸ì œì— ëŒ€í•´ í•œ ë²ˆì¯¤ì€ ìƒê°ì„ í•´ë³´ê²Œ ëœë‹¤.   
í•˜ì§€ë§Œ ê°„ë‹¨í•˜ê²Œ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë¬¸ì œê°€ ì•„ë‹ˆë‹¤.. (ì–´ë µë‹¤ğŸ˜‚)

ë‚´ê°€ ìƒê°í•˜ëŠ” ìŠ¤ë ˆë“œì™€ ë™ì‹œì„± ê´€ë¦¬ê°€ ì–´ë µë‹¤ê³  ëŠê»´ì§€ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. 

1. __ì½”ë“œë§Œ ë³´ê³  ë™ì‹œì„± ë¬¸ì œì˜ ë°œìƒ ê°€ëŠ¥ì„±ì„ íŒŒì•…í•˜ê¸° ì‰½ì§€ ì•Šë‹¤.__
2. ì¼ë°˜ì ìœ¼ë¡œ ë™ì‹œì„±ìœ¼ë¡œ ì¸í•´ ìƒê¸°ëŠ” ì˜ˆì™¸ëŠ” __ì¬í˜„í•˜ê¸° ì–´ë µë‹¤.__
3. ìµœì•…ì˜ ê²½ìš°, __ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•´ë„ ì§„ì§œ ê²°í•¨ìœ¼ë¡œ ê°„ì£¼ë˜ì§€ ì•Šê³  ì¼íšŒì„± ë¬¸ì œë¡œ ì—¬ê²¨ ë¬´ì‹œë  ìˆ˜ ìˆë‹¤.__

ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ ëŒ€ë¶€ë¶„ ìŠ¤ë ˆë“œë¥¼ í¬ê²Œ ì‹ ê²½ì“°ì§€ëŠ” ì•Šì§€ë§Œ, ë™ì‹œì„± ë¬¸ì œë¡œ ì¸í•œ ê²°í•¨ì´ ì¹˜ëª…ì ì¸ ê²°ê³¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë™ì‹œì„±ì— ëŒ€í•´ ìì„¸íˆ ì•„ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤. ë”°ë¼ì„œ ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì •ë¦¬í•´ë³´ì•˜ë‹¤.

## ê°„ë‹¨í•œ ë™ì‹œì„± ë¬¸ì œ í…ŒìŠ¤íŠ¸

```java
private static long count = 0;

@Test
void threadNotSafe() throws Exception {
    int maxCnt = 10;

    for (int i = 0; i < maxCnt; i++) {
        new Thread(() -> {
            count++;
            System.out.println(count);
        }).start();
    }

    Thread.sleep(100); // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ì ê¹ ëŒ€ê¸°
    Assertions.assertThat(count).isEqualTo(maxCnt);
}
```

ê°„ë‹¨í•œ ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì•˜ë‹¤. ë‹¤ìˆ˜ì˜ ìŠ¤ë ˆë“œë“¤ì€ ê³µìœ ìì› `static long count` ì„ ì°¸ì¡°í•˜ì—¬ ê°’ì„ ì¦ê°€ì‹œí‚¨ë‹¤.
ìœ„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ëŠ” ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì•„ë¬´ëŸ° ë¬¸ì œ ì—†ì´ í†µê³¼í•œë‹¤.
í•˜ì§€ë§Œ ê°’ì„ ì¦ê°€í•˜ëŠ” `count++` ì—°ì‚°ì´ __ì›ìì„±ì„ ë³´ì¥í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—__ ì•„ë˜ì™€ ê°™ì´ í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤.

![image](https://user-images.githubusercontent.com/69145799/149611483-5dd5455c-376f-4b14-97a8-0ce6593083ce.png){:.align-center}

> â¬† í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ê²°ê³¼ // 1ì´ ë‘ ë²ˆ ì¶œë ¥ ë˜ì—ˆë‹¤. (0 -> 1 ì¦ê°€ ì—°ì‚°ì—ì„œ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤)

# ë™ì‹œì„± ë¬¸ì œ í•´ê²° ë°©ë²•

## 1. synchronized

`synchronized` í‚¤ì›Œë“œë¥¼ í†µí•´ í•´ë‹¹ ë¸”ëŸ­ì˜ ì•¡ì„¸ìŠ¤ë¥¼ ë™ê¸°í™”í•  ìˆ˜ ìˆë‹¤.   
ê°„ë‹¨íˆ ë§í•´ì„œ `synchronized` ê°€ ì„ ì–¸ëœ ë¸”ëŸ­ì—ëŠ” ë™ì‹œì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

* ê°„ë‹¨í•œ ì‚¬ìš© ì˜ˆì œ

```java
public class SomeClass {
    // ë©”ì„œë“œ ì „ì²´ì— ë™ê¸°í™” ì ìš©
    public synchronized void foo() { 
        /* critical section */
    }

    // ë‚´ë¶€ì— ë™ê¸°í™” ë¸”ëŸ­ ìƒì„±
    public void bar() {
        synchronized (this) {
            /* critical section */
        }
    }
}

// í´ë˜ìŠ¤ ë‚´ë¶€ì˜ ì „ì—­ ë©”ì„œë“œì—ì„œ ë™ê¸°í™” ë¸”ëŸ­ì„ ìƒì„±í•˜ëŠ” ë°©ë²•
public class SomeClass {
    public static void syncMethod() {
        synchronized (SomeClass.class) {
            /* critical section */
        }
    }
}
```

ë‹¤ìŒì€ ì•ì—ì„œ ë™ì‹œì„± ë¬¸ì œë¡œ ì¸í•´ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì— `synchronized` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ ë³´ì•˜ë‹¤.

```java
private static long count = 0;

@Test
void threadNotSafe() throws Exception {
    int maxCnt = 10;

    for (int i = 0; i < maxCnt; i++) {
        new Thread(this::plus).start();
    }

    Thread.sleep(100); // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ì ê¹ ëŒ€ê¸°
    Assertions.assertThat(count).isEqualTo(maxCnt);
}

public synchronized void plus() { // synchronized í‚¤ì›Œë“œ ì‚¬ìš©
    count++;
}
```

`synchronized` ë¥¼ ì¶”ê°€í•¨ìœ¼ë¡œì¨ ìœ„ í…ŒìŠ¤íŠ¸ëŠ” 100% í†µê³¼í•  ìˆ˜ ìˆë‹¤.

íŠ¹ì • ìŠ¤ë ˆë“œëŠ” `synchronized` ë©”ì„œë“œì— ì ‘ê·¼ ì‹œ ë¸”ë¡ ì „ì²´ì— lockì„ ê±´ë‹¤. 
ë”°ë¼ì„œ í•´ë‹¹ ìŠ¤ë ˆë“œê°€ ë¸”ëŸ­ì„ ë¹ ì ¸ë‚˜ê°€ê¸° ì „ê¹Œì§€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë“¤ì€ ë™ê¸°í™” ì²˜ë¦¬ëœ ë¸”ë¡ì— ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤.
í•˜ì§€ë§Œ, ë‹¤ë¥¸ ìŠ¤ë ˆë“œë“¤ì€ ì•„ë¬´ëŸ° ì‘ì—…ì„ í•˜ì§€ ëª»í•˜ê³  ê¸°ë‹¤ë¦´ ìˆ˜ë°–ì— ì—†ì–´ ìì›ì˜ ë‚­ë¹„ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

`synchronized` ë¡œ ì„ ì–¸ëœ ë¸”ë¡ ë‚´ë¶€ì— ë³µì¡í•œ ë¡œì§ì´ ë“¤ì–´ê°„ë‹¤ê³  ìƒê°í•´ ë³´ì. ìŠ¤ë ˆë“œì˜ ê°œìˆ˜ê°€ ë§ìœ¼ë©´ ë§ì„ìˆ˜ë¡ ì‹¤í–‰ ì‹œê°„ì— ì—„ì²­ë‚œ ì§€ì—°ì´ ìƒê¸¸ ê²ƒì´ë‹¤. ì´ë¥¼ í™•ì¸í•´ ë³´ê¸° ìœ„í•´ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì•˜ë‹¤.

### ë”œë ˆì´ í…ŒìŠ¤íŠ¸ (1)

ê°€ì¥ ë¨¼ì € `synchronized` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ê²½ìš°ë¥¼ í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ë‹¤.

```java
private static long count = 0;

@Test
void threadNotSafe() throws Exception {
    int maxCnt = 1000;

    for (int i = 0; i < maxCnt; i++) {
        new Thread(this::plus).start();
    }

    Thread.sleep(1000); // 1000ms í›„ì— í…ŒìŠ¤íŠ¸ ì¢…ë£Œ(ê²°ê³¼ ê°’ì„ í™•ì¸)
    Assertions.assertThat(count).isEqualTo(maxCnt);
}

public void plus() { // synchronized ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ê²½ìš° (ë™ì‹œì„± ì œì–´ë¥¼ í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
    count++;
    try {
        Thread.sleep(1); // ì¶”ê°€ì ì¸ ë”œë ˆì´(ë³µì¡í•œ ë¡œì§ì´ ì¶”ê°€ëœë‹¤ê³  ê°€ì •)
    } catch (InterruptedException e) {
    }
}
```

`plus()` í•¨ìˆ˜ ë‚´ë¶€ì— ì¶”ê°€ì ì¸ ë”œë ˆì´ë¥¼ ë°œìƒì‹œì¼œ ë³´ì•˜ë‹¤. í…ŒìŠ¤íŠ¸ëŠ” ëŒ€ë¶€ë¶„ì˜ ê²½ìš° í†µê³¼í•˜ì§€ë§Œ `synchronized` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ìƒ, ì²˜ìŒ í…ŒìŠ¤íŠ¸ì™€ ë™ì¼í•˜ê²Œ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
í•˜ì§€ë§Œ `Thread.sleep(1)` ë”œë ˆì´ëŠ” í° ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤. (ê°ê°ì˜ ìŠ¤ë ˆë“œëŠ” ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©° critical sectionì— ì•„ë¬´ëŸ° ì œì•½ ì—†ì´ ì ‘ê·¼í•˜ê¸° ë•Œë¬¸)

### ë”œë ˆì´ í…ŒìŠ¤íŠ¸ (2)

ê·¸ë ‡ë‹¤ë©´, `synchronized` í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•˜ë©´ ì–´ë–¨ê¹Œ?

```java
public synchronized void plus() { ... } // synchronized ì‚¬ìš© (í•´ë‹¹ ë¸”ë¡ì— ë™ì‹œì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼ ê°€ëŠ¥)
```

![image](https://user-images.githubusercontent.com/69145799/149612719-0884a4c3-5a61-4fbf-aea3-a925f98c3bf3.png){:.align-center}

> â¬† synchronized ì‚¬ìš© í…ŒìŠ¤íŠ¸ ê²°ê³¼

ê²°ê³¼ê°€ ìƒë‹¹íˆ í¥ë¯¸ë¡œìš´ë°, ëª©í‘œ ê°’ì¸ 1000ì— í„±ì—†ì´ ë¶€ì¡±í•œ ê²°ê³¼ê°€ ë‚˜ì˜¨ ì´ìœ ëŠ” ê°„ë‹¨í•˜ë‹¤.

1. 1000ê°œì˜ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í–ˆë‹¤.
2. countë¥¼ ì¦ê°€í•˜ëŠ” `plus()` ë©”ì„œë“œëŠ” ë™ì‹œì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤.
3. íŠ¹ì • ìŠ¤ë ˆë“œê°€ `count++` ì—°ì‚°ì„ ëë‚¸ í›„ 1ms ë™ì•ˆ ë”œë ˆì´ë¥¼ ê°€ì§€ê³  ë‚˜ì„œì•¼ ë©”ì„œë“œë¥¼ ë¹ ì ¸ë‚˜ì˜¤ê³  lockì„ í•´ì œí•œë‹¤.
4. __í…ŒìŠ¤íŠ¸ëŠ” 1000ms í›„ì— ì¢…ë£Œë˜ë¯€ë¡œ 1000ê°œì˜ ëª¨ë“  ìŠ¤ë ˆë“œê°€ `plus()` ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ê¸°ì—ëŠ” ì‹œê°„ì´ ë¶€ì¡±í•˜ë‹¤.__
5. ë¹„ë¡ ì‹œê°„ì´ ëª¨ìë¼ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤íŒ¨í–ˆì§€ë§Œ, __ë™ì‹œì„± ì œì–´ê°€ í™•ì‹¤íˆ ë˜ê³  ìˆë‹¤ëŠ” ì __ ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

ë”°ë¼ì„œ, ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `synchronized` í‚¤ì›Œë“œëŠ” ë§¤ìš° ê°„ë‹¨í•œ í•´ê²°ë°©ë²•ì´ ë  ìˆ˜ ìˆì§€ë§Œ, critical sectionì˜ í¬ê¸°ë° ì‹¤í–‰ì‹œê°„ì— ë”°ë¼ ì„±ëŠ¥í•˜ë½ ë° ìì›ë‚­ë¹„ê°€ ë§¤ìš° ì‹¬í•´ì§€ê²Œ ëœë‹¤.

[Uncle Bob(ë¡œë²„íŠ¸ C. ë§ˆí‹´)ì˜ í´ë¦° ì½”ë“œ](http://www.yes24.com/Product/Goods/11681152){:target="_blank"} ì±…ì—ì„œë„ ë™ì‹œì„±ì— ëŒ€í•´ ë‹¤ë£¬ ë¶€ë¶„ì´ ìˆëŠ”ë°, ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- __ê³µìœ  ìë£Œë¥¼ ìµœëŒ€í•œ ì¤„ì—¬ë¼.__
- __ë™ê¸°í™”í•˜ëŠ” ë¶€ë¶„ì„ ìµœëŒ€í•œ ì‘ê²Œ ë§Œë“¤ì–´ë¼.__
- __í”„ë¡œì„¸ì„œ ìˆ˜ë³´ë‹¤ ë§ì€ ìŠ¤ë ˆë“œë¥¼ ëŒë ¤ë³´ë¼.__
- __ì½”ë“œì— ë³´ì¡° ì½”ë“œë¥¼ ë„£ì–´ ëŒë ¤ë¼. ê°•ì œë¡œ ì‹¤íŒ¨ë¥¼ ì¼ìœ¼í‚¤ê²Œ í•´ë³´ë¼.__

## 2. volatile

`volatile` í‚¤ì›Œë“œì— ëŒ€í•œ [ìì„¸í•œ ì„¤ëª…ì€ ë‹¤ë¥¸ ë¸”ë¡œê·¸ë¥¼ ì°¸ê³ í•˜ê¸° ë°”ëë‹ˆë‹¤.](https://nesoy.github.io/articles/2018-06/Java-volatile){:target="_blank"}

`volatile` ì— ëŒ€í•´ ê°„ë‹¨í•˜ê²Œ ì •ë¦¬í•´ ë³´ë©´..

JVMì—ì„œ ìŠ¤ë ˆë“œëŠ” ì‹¤í–‰ë˜ê³  ìˆëŠ” CPU ë©”ëª¨ë¦¬ ì˜ì—­ì— ë°ì´í„°ë¥¼ ìºì‹± í•œë‹¤. (CPU Cache)
ë”°ë¼ì„œ ë©€í‹° ì½”ì–´ í”„ë¡œì„¸ì„œì—ì„œ ë‹¤ìˆ˜ì˜ ìŠ¤ë ˆë“œê°€ ë³€ìˆ˜ aë¥¼ ê³µìœ í•˜ë”ë¼ë„ ìºì‹± ëœ ì‹œì ì— ë”°ë¼ ë°ì´í„°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë©°,
ì„œë¡œ ë‹¤ë¥¸ ì½”ì–´ì˜ ìŠ¤ë ˆë“œëŠ” ë°ì´í„° ê°’ì´ ë¶ˆì¼ì¹˜í•˜ëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤.

ì„ì˜ë¡œ ë°ì´í„°ë¥¼ ê°±ì‹ í•´ ì£¼ì§€ ì•ŠëŠ” ì´ìƒ __ìºì‹± ëœ ë°ì´í„°ê°€ ì–¸ì œ ê°±ì‹ ë˜ëŠ”ì§€ ë˜í•œ ì •í™•íˆ ì•Œ ìˆ˜ ì—†ë‹¤.__

ì´ëŸ° ê²½ìš° `volatile` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ CPU ë©”ëª¨ë¦¬ ì˜ì—­ì— ìºì‹± ëœ ê°’ì´ ì•„ë‹ˆë¼ __í•­ìƒ ìµœì‹ ì˜ ê°’ì„ ê°€ì§€ë„ë¡ ë©”ì¸ ë©”ëª¨ë¦¬ ì˜ì—­ì—ì„œ ê°’ì„ ì°¸ì¡°í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.__
-> ì¦‰, ë™ì¼ ì‹œì ì— ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë™ì¼í•œ ê°’ì„ ê°€ì§€ë„ë¡ ë™ê¸°í™”í•œë‹¤.

ë³€ìˆ˜ ì•ì— í‚¤ì›Œë“œë¥¼ ë¶™ì—¬ì„œ ì„ ì–¸ì´ ê°€ëŠ¥í•˜ë‹¤.

```java
public volatile long count = 0;
```

í•˜ì§€ë§Œ `volatile` ì„ í†µí•´ ëª¨ë“  ë™ê¸°í™” ë¬¸ì œê°€ í•´ê²°ë˜ëŠ” ê±´ ì•„ë‹ˆë‹¤.

ì•ì—ì„œ ì˜ˆë¡œ ë“¤ì—ˆë˜ `++` ì—°ì‚°ê³¼ ê°™ì´ ì›ìì„±ì´ ë³´ì¥ë˜ì§€ ì•ŠëŠ” ê²½ìš° ë™ì‹œì„± ë¬¸ì œëŠ” ë™ì¼í•˜ê²Œ ë°œìƒí•œë‹¤.
(ë‹¨ì§€ ë©€í‹° ì½”ì–´ì—ì„œì˜ ëª¨ë“  ìŠ¤ë ˆë“œê°€ ìºì‹œ ì—†ì´ ìµœì‹ ì˜ ê°’ì„ ë³´ê²Œ í•  ë¿ì´ë‹¤!)

```java
private static volatile long count = 0; // volatile í‚¤ì›Œë“œ ì¶”ê°€

@Test
void threadNotSafe() throws Exception {
    int maxCnt = 1000;

    for (int i = 0; i < maxCnt; i++) {
        new Thread(() -> count++).start();
    }

    Thread.sleep(100); // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë ë•Œ ê¹Œì§€ ì ê¹ ëŒ€ê¸°
    Assertions.assertThat(count).isEqualTo(maxCnt);
}
```

![image](https://user-images.githubusercontent.com/69145799/149614756-7055cbfb-b48a-4dd3-a757-9815effc4af5.png){:.align-center}

> â¬† ì¸í…”ë¦¬ì œì´ëŠ” ì¹œì ˆí•˜ê²Œë„ volatile í•„ë“œì— ë¹„ ì›ìì  ì—°ì‚°ì´ ìˆë‹¤ëŠ” ê²½ê³ ë¥¼ í•´ì¤€ë‹¤ ã…ã…

![image](https://user-images.githubusercontent.com/69145799/149614599-42e40249-c115-4bb4-ba6b-14066fd364bc.png){:.align-center}

> â¬† ë™ì‹œì„± ë¬¸ì œë¡œ ì¸í•´ ì‹¤íŒ¨í•œ ì¼€ì´ìŠ¤ (volatile í‚¤ì›Œë“œë„ ì›ìì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠëŠ” ì—°ì‚°ì—ì„œëŠ” ë™ì¼í•œ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•œë‹¤.)

ë”°ë¼ì„œ, `volatile` ì˜ íŠ¹ì§•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

1. mutual exclusion(ìƒí˜¸ ë°°ì œ)ë¥¼ ì œê³µí•˜ì§€ ì•Šê³ ë„ ë°ì´í„° ë³€ê²½ì˜ ê°€ì‹œì„±ì„ ë³´ì¥í•œë‹¤.
2. ì›ìì  ì—°ì‚°ì—ì„œë§Œ ë™ê¸°í™”ë¥¼ ë³´ì¥í•œë‹¤.

## 3. Atomic í´ë˜ìŠ¤

ì•ì—ì„œ ì„¤ëª…í•œ ë‘ ê°€ì§€ í‚¤ì›Œë“œ `synchronized`, `volatile` ë§Œìœ¼ë¡œëŠ” ë™ì‹œì„± ë¬¸ì œë¥¼ ê¹”ë”í•˜ê²Œ í•´ê²°í•  ìˆ˜ ì—†ë‹¤.

ìë°”ì—ì„œëŠ” ìœ„ ë¬¸ì œë“¤ì„ í•´ê²°í•˜ê¸° ìœ„í•´, ë¹„-ì›ìì  ì—°ì‚°ì—ì„œë„ ë™ê¸°í™”ë¥¼ ë¹ ë¥´ê³  ì‰½ê²Œ ì´ìš©í•˜ê¸° ìœ„í•œ í´ë˜ìŠ¤ ëª¨ìŒì„ ì œê³µí•œë‹¤.

`java.util.concurrent.*` (ëŒ€í‘œì ìœ¼ë¡œ ì»¬ë ‰ì…˜, Wrapper í´ë˜ìŠ¤ ë“±ì´ ìˆë‹¤.)

* `java.util.concurrent.atomic.AtomicLong`

```java
public class AtomicLong extends Number implements java.io.Serializable {
	
    private volatile long value; // volatile í‚¤ì›Œë“œê°€ ì ìš©ë˜ì–´ ìˆë‹¤.
	
    public final long incrementAndGet() { // value ê°’ì„ ì‹¤ì œë¡œ ì¦ê°€ì‹œí‚¤ëŠ” ë©”ì„œë“œ
        return U.getAndAddLong(this, VALUE, 1L) + 1L;
    }
	
}
```

* `jdk.internal.misc.Unsafe`

```java
public final class Unsafe {
    // ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ê°’ê³¼ CPUì— ìºì‹œëœ ê°’ì„ ë¹„êµí•´ ë™ì¼í•œ ê²½ìš°ì—ë§Œ update ìˆ˜í–‰
    public final long getAndAddLong(Object o, long offset, long delta) {
        long v;
        do {
            v = getLongVolatile(o, offset);
        } while (!weakCompareAndSetLong(o, offset, v, v + delta)); // CAS ì•Œê³ ë¦¬ì¦˜ (JNI ì½”ë“œë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤.)
        return v;
    }
}
```

Non-Blocking ì„ì—ë„ ë™ì‹œì„±ì„ ë³´ì¥í•˜ëŠ” ì´ìœ ëŠ” `CAS(Compare-and-swap)` ì•Œê³ ë¦¬ì¦˜ì„ ì´ìš©í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

- `volatile` í‚¤ì›Œë“œë¥¼ ì´ìš©í•˜ë©´ì„œ í˜„ì¬ ìŠ¤ë ˆë“œì— ì €ì¥ëœ ê°’ê³¼ ë©”ì¸ ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ê°’ì„ ë¹„êµí•œë‹¤.
   - ì¼ì¹˜í•˜ëŠ” ê²½ìš° ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ êµì²´(thread-safe í•œ ìƒíƒœì´ë¯€ë¡œ ë¡œì§ ìˆ˜í–‰)
   - ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì‹¤íŒ¨ í›„ ì¬ì‹œë„(thread-safe í•˜ì§€ ì•Šì€ ìƒíƒœì˜€ìœ¼ë¯€ë¡œ ì¬ì‹œë„)

### ì„±ëŠ¥ ë¹„êµ í…ŒìŠ¤íŠ¸

Blocking vs Non-Blocking ì— ëŒ€í•´ ì†ë„ ë¹„êµë¥¼ ê°„ë‹¨íˆ í•´ë³´ì•˜ë‹¤.

* Blocking (synchronized)

```java
private static long startTime = System.currentTimeMillis();
private static int maxCnt = 1000;
private static long count = 0;

@Test
void threadNotSafe() throws Exception {
    for (int i = 0; i < maxCnt; i++) {
        new Thread(this::plus).start();
    }

    Thread.sleep(2000); // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë ë•Œ ê¹Œì§€ ì ê¹ ëŒ€ê¸°
    Assertions.assertThat(count).isEqualTo(maxCnt);
}

public synchronized void plus() {
    if (++count == maxCnt) {
        System.out.println(System.currentTimeMillis() - startTime);
    }
    try {
        Thread.sleep(1);
    } catch (InterruptedException e) {
    }
}
```

![image](https://user-images.githubusercontent.com/69145799/149615263-d1c059a2-467d-4ee1-a152-eae70a12356c.png){:.align-center}

> í‰ê·  1300ms ì •ë„ ì†Œìš”ë˜ì—ˆë‹¤. (Blocking ì—°ì‚°ì—ì„œ 1000ê°œì˜ ìŠ¤ë ˆë“œê°€ ê°ê° 1msì˜ ì¶”ê°€ ë”œë ˆì´ë¥¼ ê°€ì§€ê¸° ë•Œë¬¸)


* Non-Blocking (AtomicLong)

```java
private static long startTime = System.currentTimeMillis();
private static int maxCnt = 1000;
private static AtomicLong count2 = new AtomicLong();

@Test
void threadNotSafe2() throws Exception {
    for (int i = 0; i < maxCnt; i++) {
        new Thread(this::plus2).start();
    }

    Thread.sleep(2000); // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë ë•Œ ê¹Œì§€ ì ê¹ ëŒ€ê¸°
    Assertions.assertThat(count2.get()).isEqualTo(maxCnt);
}

public void plus2() {
    if (count2.incrementAndGet() == maxCnt) {
        System.out.println(System.currentTimeMillis() - startTime);
    }
    try {
        Thread.sleep(1);
    } catch (InterruptedException e) {
    }
}
```

![image](https://user-images.githubusercontent.com/69145799/149615309-0dc44641-89f1-40da-a868-21ccca99fb53.png){:.align-center}

> í‰ê·  140ms ì •ë„ ì†Œìš”ë˜ì—ˆë‹¤. (Non-Blocking ì—°ì‚°ì—ì„œ 1msì˜ ì¶”ê°€ ë”œë ˆì´ëŠ” í° ì˜ë¯¸ê°€ ì—†ë‹¤.)

ë‹¹ì—°í•œ ê²°ê³¼ì´ì§€ë§Œ, `synchronized` í‚¤ì›Œë“œëŠ” íš¨ê³¼ì ì¸ ì„±ëŠ¥ê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ê¸°ì—ëŠ” í° ì–´ë ¤ì›€ì´ ìˆë‹¤.

# ë§ˆë¬´ë¦¬

í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì„ì˜ë¡œ ë”œë ˆì´ë¥¼ 1msë¡œ ì£¼ì—ˆê¸° ë•Œë¬¸ì— ê²°ê³¼ê°€ ë“œë¼ë§ˆí‹± í•˜ê²Œ ì°¨ì´ ë‚œë‹¤ê³  ë§í•  ìˆ˜ë„ ìˆë‹¤.

```java
public void plus() {
    synchronized (this) {
        if (++count == maxCnt) {
            System.out.println(System.currentTimeMillis() - startTime);
        }
    }
    try {
        Thread.sleep(1);
    } catch (InterruptedException e) {
    }
}
```

ìœ„ì™€ ê°™ì´ `plus()` ë©”ì„œë“œì—ì„œ ë™ê¸°í™”ê°€ í•„ìš”í•œ ë¶€ë¶„ë§Œ `synchronized` ë¸”ë¡ìœ¼ë¡œ ê°ì‹¸ì£¼ë©´ ì„±ëŠ¥í•˜ë½ì´ ìƒê¸°ì§€ ì•ŠëŠ”ë‹¤.

í•˜ì§€ë§Œ, ì‹¤ì œ í”„ë¡œê·¸ë˜ë°ì—ì„œ ìœ„ í…ŒìŠ¤íŠ¸ ì½”ë“œì™€ ê°™ì´ ë™ì‹œì„± ë¬¸ì œê°€ ì˜ˆìƒë˜ëŠ” ê³³ë“¤ì„ ëª¨ë‘ íŒŒì•…í•´ì„œ `synchronzied` ë¥¼ í†µí•´ ë™ê¸°í™” ì„¤ì •ì„ í•  ìˆ˜ ìˆì„ê¹Œ?

ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‚¬ì´ì‚¬ì´ì— ë“¤ì–´ê°€ ìˆëŠ” ë¹„-ì›ìì  ì—°ì‚°ì„ ì—¬ëŸ¬ê°œì˜ `synchronized` ë¸”ë¡ìœ¼ë¡œ ì„¤ì •í•˜ëŠ”ê±´ ê°€ëŠ¥í•˜ê² ì§€ë§Œ ì½”ë“œê°€ ë³µì¡í•´ì§ˆ ê²ƒì´ê³ , ê°œë°œìê°€ ëª¨ë“  ì½”ë“œì— ë™ì‹œì„± ë¬¸ì œë¥¼ í•˜ë‚˜í•˜ë‚˜ ê²€í† í•´ì•¼ë§Œ ì™„ë²½í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

ë”°ë¼ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” concurrent íŒ¨í‚¤ì§€ì˜ í´ë˜ìŠ¤ë“¤ì„ ì´ìš©í•˜ëŠ” ê²ƒì´ ìë°”ì—ì„œ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ì ì ˆí•œ ë°©ë²•ì´ë¼ê³  ìƒê°í•œë‹¤.

> __ëª¨ë“  ì½”ë“œëŠ” ì‹¤ì œ ì‘ì„±í•˜ì˜€ìœ¼ë©°, ì§ì ‘ ì‹¤í–‰í•œ ê²°ê³¼ë“¤ì„ ê¸€ì— ë‹´ì•˜ìŠµë‹ˆë‹¤.__   
> __ë‚´ìš©ì— ì˜¤ë¥˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê´€ë ¨ ì½”ë©˜íŠ¸ë¥¼ ì£¼ì‹œë©´ ê°ì‚¬íˆ ë°›ê² ìŠµë‹ˆë‹¤.__   
> __ëª¨ë“  ì˜ê²¬ì€ ì–¸ì œë‚˜ í™˜ì˜í•©ë‹ˆë‹¤ ğŸ˜Š__

# References

* [Atomic Type vs Synchronized](https://n1tjrgns.tistory.com/244){:target="_blank"}
* [ìë°” ê³ ìœ ë½ê³¼ Synchronization](https://brunch.co.kr/@kd4/156){:target="_blank"}
* [Java volatileì´ë€?](https://nesoy.github.io/articles/2018-06/Java-volatile){:target="_blank"}
* [Oracle Docs - AtomicLong](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicLong.html){:target="_blank"}
* [Compare-and-swap](https://en.wikipedia.org/wiki/Compare-and-swap){:target="_blank"}